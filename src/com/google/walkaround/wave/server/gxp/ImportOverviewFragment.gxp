<?xml version='1.0' ?>
<!--
  Copyright (C) 2011 Google Inc.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

  Author: ohler@google.com (Christian Ohler)
-->
<!DOCTYPE gxp:template SYSTEM
  'http://gxp.googlecode.com/svn/trunk/resources/xhtml.ent'>
<gxp:template name='com.google.walkaround.wave.server.gxp.ImportOverviewFragment'
  xmlns='http://www.w3.org/1999/xhtml'
  xmlns:expr='http://google.com/2001/gxp/expressions'
  xmlns:gxp='http://google.com/2001/gxp'
  xmlns:call='http://google.com/2001/gxp/call'
  xmlns:nomsg='http://google.com/2001/gxp/nomsg'>

  <gxp:import class='com.google.walkaround.wave.server.gxp.ImportWaveletDisplayRecord'/>
  <gxp:import class='org.waveprotocol.wave.model.id.IdUtil'/>
  <gxp:import class='java.util.List'/>

  <gxp:param name='userEmail' type='String'/>
  <gxp:param name='token' type='String'/>
  <!-- GXP won't let us <gxp:eval> inside <input>, and I can't get
       form:form to work, and I can't get html:html to work.  So we
       include an HTML snippet generated by hand-written servlet
       code. -->
  <gxp:param name='instanceSelectionHtml' type='HtmlClosure'/>
  <gxp:param name='tasksInProgress' type='List{String}'/>
  <gxp:param name='waveRecords' type='List{ImportWaveletDisplayRecord}'/>

  <style type='text/css'>
    .main {
      z-index: 1000;
    }
    #panel {
      padding: 10px 40px;
    }
    table {
      border-collapse: collapse;
      font-size: 90%;
      table-layout: fixed;
      width: 100%;
      border-bottom: 1px solid lightgray;
    }
    td {
      padding: 10px;
      overflow: hidden;
    }
    th {
      border-bottom: 1px solid lightgray;
      font-weight: bold;
      border-top: 1px solid lightgray;
      border-bottom: 1px solid lightgray;
      padding: 10px;
      text-align: left;
    }
    .titlecolumn {
      width: 40%;
    }
  </style>

  <div id='panel'>
    <h3><gxp:msg>Import status for</gxp:msg> <gxp:eval expr='userEmail'/></h3>

    <gxp:if cond='!tasksInProgress.isEmpty()'>
      <h4><gxp:msg>Import in progress</gxp:msg></h4>
      <gxp:eval expr='tasksInProgress.size()'/> <gxp:msg>tasks in progress (reload page
        to update)</gxp:msg>
      <!-- This option can cause data loss, so it should probably
           not exist or be more hidden; but for now, it's useful for
           debugging. -->
      <form method='post' action='import'>
        <input type='hidden' name='action' value='canceltasks'/>
        <input type='hidden' name='token' expr:value='token'/>
        <input type='submit' value='cancel all tasks (!)'/>
      </form>
      <ol>
        <gxp:loop var='task' type='String' iterable='tasksInProgress'>
          <li><gxp:eval expr='task'/></li>
        </gxp:loop>
      </ol>
      <br/>
      <br/>
    <gxp:else/>
      <gxp:msg>No import tasks in progress</gxp:msg>
      <br/>
      <br/>
    </gxp:if>

    <gxp:if cond='!waveRecords.isEmpty()'>
      <h4><gxp:msg>Remote waves</gxp:msg></h4>
      <p>
        <gxp:if cond='tasksInProgress.isEmpty()'>
          <gxp:eval expr='waveRecords.size()'/> <gxp:msg>remote waves</gxp:msg>
        <gxp:else/>
          <gxp:eval expr='waveRecords.size()'/> <gxp:msg>remote waves found so far</gxp:msg>
        </gxp:if>
        <!-- This option can cause data loss, so it should probably
             not exist or be more hidden; but for now, it's useful for
             debugging. -->
        <form method='post' action='import'>
          <input type='hidden' name='action' value='forgetwaves'/>
          <input type='hidden' name='token' expr:value='token'/>
          <input type='submit' value='forget all remote waves (!)'/>
        </form>
      </p>
      <table>
        <thead>
          <tr>
            <th><gxp:msg>Origin</gxp:msg></th>
            <th><gxp:msg>Creator</gxp:msg></th>
            <th class='titlecolumn'><gxp:msg>Title</gxp:msg></th>
            <th><gxp:msg>Last modified</gxp:msg></th>
            <th><gxp:msg>Type</gxp:msg></th>
            <th><gxp:msg>Private import</gxp:msg></th>
            <th><gxp:msg>Shared import</gxp:msg></th>
          </tr>
        </thead>
        <tbody>
          <gxp:loop var='record' type='ImportWaveletDisplayRecord' iterable='waveRecords'>
            <tr>
              <td>
                <a expr:href='record.getLinkToOriginal()' target='_blank'>
                  <gxp:eval expr='record.getInstance().getShortName()'/>
                </a>
              </td>
              <td><gxp:eval expr='record.getCreator()'/></td>
              <td><gxp:eval expr='record.getTitle()'/></td>
              <td><gxp:eval expr='record.getLastModifiedDate()'/></td>
              <td>
                <gxp:if
                   cond='IdUtil.isConversationRootWaveletId(record.getWaveletName().waveletId)'>
                  <gxp:msg>wave</gxp:msg>
                  <gxp:else/>
                  <gxp:msg>private reply</gxp:msg>
                </gxp:if>
              </td>
              <td>
                <call:ImportWaveletButtonFragment
                   isPrivate='true' expr:token='token' expr:record='record'/>
              </td>
              <td>
                <call:ImportWaveletButtonFragment
                   isPrivate='false' expr:token='token' expr:record='record'/>
              </td>
            </tr>
          </gxp:loop>
        </tbody>
      </table>
      <br/>
      <br/>
    </gxp:if>

    <h3><gxp:msg>Start new import</gxp:msg></h3>
    <form method='post' action='import'>
      <b><gxp:msg>Find waves to import manually</gxp:msg></b>
      <br/>
      <gxp:eval expr='instanceSelectionHtml'/>
      <input type='hidden' name='action' value='findwaves'/>
      <input type='hidden' name='token' expr:value='token'/>
      <input type='submit' value='Find waves to import'/>
    </form>

    <br/>
    <form method='post' action='import'>
      <b><gxp:msg>Find and import all waves</gxp:msg></b>
      <br/>
      <gxp:eval expr='instanceSelectionHtml'/>
      <gxp:nomsg>Sharing of imported wave:</gxp:nomsg>
      <input type='radio' name='sharingmode' value='private'/><gxp:nomsg> private</gxp:nomsg>
      <input type='radio' name='sharingmode' value='shared'/><gxp:nomsg> shared</gxp:nomsg>
      <input type='radio' name='sharingmode' value='privateunlessparticipant'/>
      <gxp:nomsg>shared if I am a participant, private otherwise</gxp:nomsg>
      <input type='hidden' name='action' value='findandimport'/>
      <input type='hidden' name='token' expr:value='token'/>
      <br/>
      <input type='submit' value='Find and import all waves'/>
    </form>

    <br/>
    <b><gxp:msg>Import wavelet by ID</gxp:msg></b>
    <form method='post' action='import'>
      <input type='hidden' name='action' value='importwavelet'/>
      <input type='hidden' name='token' expr:value='token'/>
      <gxp:nomsg>Wave ID: </gxp:nomsg><input name='waveid'/>
      <gxp:nomsg>Wavelet ID: </gxp:nomsg><input name='waveletid'/>
      <br/>
      <gxp:eval expr='instanceSelectionHtml'/>
      <gxp:nomsg>Sharing:</gxp:nomsg>
      <input type='radio' name='sharingmode' value='private'/><gxp:nomsg> private</gxp:nomsg>
      <input type='radio' name='sharingmode' value='shared'/><gxp:nomsg> shared</gxp:nomsg>
      <br/>
      <input type='submit' value='Import wavelet'/>
    </form>

    <br/>
    <br/>
    <gxp:msg>
      Private import creates a copy of the wave where you are the
      only participant.
    </gxp:msg>
    <br/>
    <gxp:msg>
      Shared import creates a copy of the wave that is shared with the
      original participants, or adds you to such a copy if another
      user has already done a shared import.  With shared import, you
      will be added to the participant list of the imported copy even
      if you were not a participant on the original (and had access
      through a group or because the wave was public).
    </gxp:msg>
  </div>

</gxp:template>
